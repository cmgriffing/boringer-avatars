const p={};function m(t){p.context=t}function F(){return{...p.context,id:`${p.context.id}${p.context.count++}-`,count:0}}const H=(t,e)=>t===e,g={equals:H};let R=q;const h=1,v=2,k={owned:null,cleanups:null,context:null,owner:null};var c=null;let a=null,u=null,i=null,f=null,E=0;function G(t,e){const s=u,n=c,r=t.length===0,l=r?k:{owned:null,cleanups:null,context:null,owner:e===void 0?n:e},o=r?t:()=>t(()=>b(()=>y(l)));c=l,u=null;try{return w(o,!0)}finally{u=s,c=n}}function I(t,e){e=e?Object.assign({},g,e):g;const s={value:t,observers:null,observerSlots:null,comparator:e.equals||void 0},n=r=>(typeof r=="function"&&(r=r(s.value)),C(s,r));return[A.bind(s),n]}function M(t,e,s){const n=T(t,e,!1,h);x(n)}function d(t,e,s){s=s?Object.assign({},g,s):g;const n=T(t,e,!0,0);return n.observers=null,n.observerSlots=null,n.comparator=s.equals||void 0,x(n),A.bind(n)}function b(t){if(u===null)return t();const e=u;u=null;try{return t()}finally{u=e}}function A(){const t=a;if(this.sources&&(this.state||t))if(this.state===h||t)x(this);else{const e=i;i=null,w(()=>S(this),!1),i=e}if(u){const e=this.observers?this.observers.length:0;u.sources?(u.sources.push(this),u.sourceSlots.push(e)):(u.sources=[this],u.sourceSlots=[e]),this.observers?(this.observers.push(u),this.observerSlots.push(u.sources.length-1)):(this.observers=[u],this.observerSlots=[u.sources.length-1])}return this.value}function C(t,e,s){let n=t.value;return(!t.comparator||!t.comparator(n,e))&&(t.value=e,t.observers&&t.observers.length&&w(()=>{for(let r=0;r<t.observers.length;r+=1){const l=t.observers[r],o=a&&a.running;o&&a.disposed.has(l),(o&&!l.tState||!o&&!l.state)&&(l.pure?i.push(l):f.push(l),l.observers&&N(l)),o||(l.state=h)}if(i.length>1e6)throw i=[],new Error},!1)),e}function x(t){if(!t.fn)return;y(t);const e=c,s=u,n=E;u=c=t,j(t,t.value,n),u=s,c=e}function j(t,e,s){let n;try{n=t.fn(e)}catch(r){t.pure&&(t.state=h,t.owned&&t.owned.forEach(y),t.owned=null),O(r)}(!t.updatedAt||t.updatedAt<=s)&&(t.updatedAt!=null&&"observers"in t?C(t,n):t.value=n,t.updatedAt=s)}function T(t,e,s,n=h,r){const l={fn:t,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:e,owner:c,context:null,pure:s};return c===null||c!==k&&(c.owned?c.owned.push(l):c.owned=[l]),l}function U(t){const e=a;if(t.state===0||e)return;if(t.state===v||e)return S(t);if(t.suspense&&b(t.suspense.inFallback))return t.suspense.effects.push(t);const s=[t];for(;(t=t.owner)&&(!t.updatedAt||t.updatedAt<E);)(t.state||e)&&s.push(t);for(let n=s.length-1;n>=0;n--)if(t=s[n],t.state===h||e)x(t);else if(t.state===v||e){const r=i;i=null,w(()=>S(t,s[0]),!1),i=r}}function w(t,e){if(i)return t();let s=!1;e||(i=[]),f?s=!0:f=[],E++;try{const n=t();return L(s),n}catch(n){s||(f=null),i=null,O(n)}}function L(t){if(i&&(q(i),i=null),t)return;const e=f;f=null,e.length&&w(()=>R(e),!1)}function q(t){for(let e=0;e<t.length;e++)U(t[e])}function S(t,e){const s=a;t.state=0;for(let n=0;n<t.sources.length;n+=1){const r=t.sources[n];r.sources&&(r.state===h||s?r!==e&&U(r):(r.state===v||s)&&S(r,e))}}function N(t){const e=a;for(let s=0;s<t.observers.length;s+=1){const n=t.observers[s];(!n.state||e)&&(n.state=v,n.pure?i.push(n):f.push(n),n.observers&&N(n))}}function y(t){let e;if(t.sources)for(;t.sources.length;){const s=t.sources.pop(),n=t.sourceSlots.pop(),r=s.observers;if(r&&r.length){const l=r.pop(),o=s.observerSlots.pop();n<r.length&&(l.sourceSlots[o]=n,r[n]=l,s.observerSlots[n]=o)}}if(t.owned){for(e=0;e<t.owned.length;e++)y(t.owned[e]);t.owned=null}if(t.cleanups){for(e=0;e<t.cleanups.length;e++)t.cleanups[e]();t.cleanups=null}t.state=0,t.context=null}function $(t){return t instanceof Error||typeof t=="string"?t:new Error("Unknown error")}function O(t){throw t=$(t),t}let D=!1;function P(){D=!0}function Q(t,e){if(D&&p.context){const s=p.context;m(F());const n=b(()=>t(e||{}));return m(s),n}return b(()=>t(e||{}))}function V(t){let e=!1;const s=t.keyed,n=d(()=>t.when,void 0,{equals:(r,l)=>e?r===l:!r==!l});return d(()=>{const r=n();if(r){const l=t.children,o=typeof l=="function"&&l.length>0;return e=s||o,o?b(()=>l(r)):l}return t.fallback},void 0,void 0)}export{V as S,Q as a,M as b,I as c,G as d,P as e,p as s};
